<!DOCTYPE html>
<html>
<head>
    <title>Teste API Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin: 20px 0; padding: 15px; border: 1px solid #ddd; background: #f9f9f9; }
        .error { background: #ffe6e6; border-color: #ff9999; }
        .success { background: #e6ffe6; border-color: #99ff99; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>üîç Teste de Debug da API</h1>
    
    <button onclick="testDirectFetch()">Teste Fetch Direto</button>
    <button onclick="testWithTransform()">Teste com Transforma√ß√£o</button>
    <button onclick="clearResults()">Limpar Resultados</button>
    
    <div id="results"></div>

    <script>
        function addResult(title, content, isError = false) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${isError ? 'error' : 'success'}`;
            resultDiv.innerHTML = `
                <h3>${title}</h3>
                <pre>${content}</pre>
            `;
            resultsDiv.appendChild(resultDiv);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testDirectFetch() {
            console.log('üîç Iniciando teste de fetch direto...');
            
            try {
                const response = await fetch('http://localhost:5000/api/metrics', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                });
                
                console.log('üîç Response:', response);
                console.log('üîç Response status:', response.status);
                console.log('üîç Response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üîç Raw result:', result);
                
                addResult('‚úÖ Fetch Direto - Sucesso', JSON.stringify({
                    status: response.status,
                    success: result.success,
                    successType: typeof result.success,
                    hasData: 'data' in result,
                    dataNiveis: result.data?.niveis ? 'Presente' : 'Ausente',
                    dataKeys: result.data ? Object.keys(result.data) : 'N/A'
                }, null, 2));
                
            } catch (error) {
                console.error('üîç Erro no fetch direto:', error);
                addResult('‚ùå Fetch Direto - Erro', error.message, true);
            }
        }
        
        async function testWithTransform() {
            console.log('üîç Iniciando teste com transforma√ß√£o...');
            
            try {
                const response = await fetch('http://localhost:5000/api/metrics');
                const result = await response.json();
                
                // Simular a valida√ß√£o isApiResponse
                const isValidResponse = (
                    typeof result === 'object' &&
                    result !== null &&
                    typeof result.success === 'boolean'
                );
                
                console.log('üîç Valida√ß√£o isApiResponse:', isValidResponse);
                
                if (isValidResponse) {
                    // Simular transformLegacyData
                    const defaultLevel = {
                        novos: 0,
                        pendentes: 0,
                        progresso: 0,
                        resolvidos: 0,
                        total: 0,
                    };
                    
                    let transformedData;
                    if (result.data?.niveis) {
                        console.log('üîç Usando estrutura niveis');
                        transformedData = {
                            niveis: {
                                n1: result.data.niveis.n1 || defaultLevel,
                                n2: result.data.niveis.n2 || defaultLevel,
                                n3: result.data.niveis.n3 || defaultLevel,
                                n4: result.data.niveis.n4 || defaultLevel,
                                geral: result.data.niveis.geral || defaultLevel,
                            },
                            tendencias: result.data?.tendencias,
                        };
                    } else {
                        console.log('üîç Usando fallback');
                        transformedData = {
                            niveis: {
                                n1: result.data?.n1 || defaultLevel,
                                n2: result.data?.n2 || defaultLevel,
                                n3: result.data?.n3 || defaultLevel,
                                n4: result.data?.n4 || defaultLevel,
                                geral: result.data?.geral || defaultLevel,
                            },
                        };
                    }
                    
                    console.log('üîç Dados transformados:', transformedData);
                    
                    addResult('‚úÖ Transforma√ß√£o - Sucesso', JSON.stringify({
                        originalSuccess: result.success,
                        validationPassed: isValidResponse,
                        usedNiveisStructure: !!result.data?.niveis,
                        transformedNiveis: transformedData.niveis,
                        hasN1Data: transformedData.niveis.n1.total > 0,
                        hasN2Data: transformedData.niveis.n2.total > 0,
                        hasN3Data: transformedData.niveis.n3.total > 0,
                        hasN4Data: transformedData.niveis.n4.total > 0
                    }, null, 2));
                    
                } else {
                    addResult('‚ùå Transforma√ß√£o - Valida√ß√£o Falhou', JSON.stringify({
                        result,
                        isObject: typeof result === 'object',
                        isNotNull: result !== null,
                        hasSuccess: 'success' in result,
                        successType: typeof result?.success
                    }, null, 2), true);
                }
                
            } catch (error) {
                console.error('üîç Erro na transforma√ß√£o:', error);
                addResult('‚ùå Transforma√ß√£o - Erro', error.message, true);
            }
        }
    </script>
</body>
</html>